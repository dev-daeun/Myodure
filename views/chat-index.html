<!doctype html>
<html lang="en">
  <head>
    <script src="/socket.io/socket.io.js"></script>

    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, shrink-to-fit=no" />
    <meta name="description" content="">
    <meta name="author" content="">
    <title>대화 목록</title>

    <!-- Bootstrap core CSS -->
    <link href="css/bootstrap.min.css" rel="stylesheet">
    <!-- Custom styles for this template -->
    <link href="css/modern-business.css" rel="stylesheet">
    <link href="css/app.css" rel="stylesheet">
    <script src="js/app.js"></script>
    <script src="js/routes.js"></script>
    <script src="js/angular.js"></script>
  </head>

  <style>
    .message-input, .message-input .inline-label, .menu-bar {margin-bottom: 13;}
    #sidebar, .messages {border-right: 1px solid #eee;}
    .message-side-bar {border-left: 1px solid #eee;}
    .avatar-section {border-top: 1px solid #eee;}
  </style>

  <body>
    <div id="navigation"></div>
  </body>
  
  <!-- jQuery -->
  <script src="../vendor/jquery/jquery.min.js"></script>
  <script>
    var socket;
      $(() => {
          $.get('/nav', (data) => {
            $("#navigation").replaceWith(data);
          })
         
          socket = io.connect();
          $.ajax({
              processData: false,
              url: '/chat/list',
              method: 'GET',
              dataType: 'json',
              success: function(list){
                for(let i = 0; i<list.length; i++)
                    $('#chatlist').append(`
                        <div class="chat-element">
                        <h4 id="`+list[i].id+`">`+list[i].username+`</h4>
                        <button class="btn btn-danger" style="display:none;" value="`+list[i].unread+`">`+list[i].unread+`</button>
                        <p>`+list[i].content+`</p>
                        <h6>`+list[i].sent_time+`</h6>
                        <hr />
                      </div>`)
              },
              error: function(xhr, status, err){
                alert(xhr.responseText);
              }
            })
          $("body").on("click", ".chat-element", (ent) => {
              socket.emit("enterRoom", parseInt($(ent.target).attr("id"))); 
          });

          /* 메세지 전송 이벤트 */
          $("body").on("keypress", '.form-control', (ent) => {
              let keycode = (event.keyCode ? event.keyCode : event.which);
              if(keycode == '13') sendMessage();
          });

          $('body').on('click', '#send-button', (ent) => {
              sendMessage();
          });
         
          socket.on("enumMessages", (messages) => {
              let message = JSON.parse(messages);
              $("#chatlist").children().remove();
              for(let i = 0; i<message.length; i++) { 
                  let color;
                  if(message[i].sender_id!=1) color="#ffffff";
                  else color = "#ffd891"; //본인이면 메세지 창 노란색
                  $("#chatlist").append(`<div class="msg-element" value="`+message[i].sender_id+`">
                                            <div style="background-color: `+color+`;">
                                              <h4>`+message[i].username+`</h4>
                                              <p>`+message[i].content+`</p>
                                              <h6>`+message[i].sent_time+`</h6>
                                              <hr />
                                            </div>
                                          </div>`);                    
              } 
              $("#board").append(`<div class="message-input grid-content collapse shrink">
                                    <input type="text" placeholder="Message" class="form-control">
                                    <button id="send-button" class="form-control button">Send</button>
                                  </div>`);
              $("#board").val(message[0].talk_id);
          });  


          socket.on("appendMessage", packet => {
            let color;
            if(packet.senderId!=1) color="#ffffff";
            else color = "#ffd891"; //본인이면 메세지 창 노란색
            $("#chatlist").append(`<div class="msg-element" value="`+packet.senderId+`">
                                      <div style="background-color: `+color+`;">
                                        <h4>`+packet.senderName+`</h4>
                                        <p>`+packet.content+`</p>
                                        <h6>`+packet.sentTime+`</h6>
                                        <hr />
                                      </div>
                                    </div>`);  
          });

          socket.on("unauth", message => {
                return alert(message);
          });
      });

    function sendMessage(){
        if($(".form-control").val()=="") return alert("메시지 내용을 입력하세요.");
        socket.emit("sendMessage", {
            content: $(".form-control").val(),
            senderId: 1, 
            talkId: parseInt($("#board").val())
        });
    }
  </script>
</html>

<!-- ui-view  -->